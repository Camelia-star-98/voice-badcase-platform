# ğŸ” ä¸ºä»€ä¹ˆæˆ‘å¡«äº†å­—æ®µï¼Œåˆ«äººå´çœ‹ä¸åˆ°ï¼Ÿ

## ğŸ“‹ é—®é¢˜è¯Šæ–­

ä»ä½ çš„æˆªå›¾å’Œé”™è¯¯æ—¥å¿—å¯ä»¥çœ‹åˆ°ï¼š

```
âŒ Error: Could not find the 'date' column of 'badcases' in the schema cache
```

**è¿™æ˜¯å…¸å‹çš„ "è¡¨ç»“æ„ä¸åŒæ­¥" é—®é¢˜ï¼**

---

## ğŸ¯ **é—®é¢˜æ ¹æº**

### **åŸå›  1: æ•°æ®åº“è¡¨ç¼ºå°‘å­—æ®µ**

ä½ çš„ Supabase æ•°æ®åº“è¡¨ `badcases` å¯èƒ½ç¼ºå°‘æŸäº›å­—æ®µï¼Œä¾‹å¦‚ï¼š
- `date` ï¼ˆæ—¥æœŸï¼‰
- `subject` ï¼ˆå­¦ç§‘ï¼‰
- `location` ï¼ˆå‡ºç°ä½ç½®ï¼‰
- `reporter` ï¼ˆææŠ¥äººï¼‰
- `full_tts_lesson_id`
- `cms_id`
- `model_id`
- `audio_url`

**ç—‡çŠ¶ï¼š**
- å‰ç«¯è¡¨å•å¯ä»¥å¡«å†™
- æäº¤æ—¶æŠ¥é”™ "Could not find the 'date' column"
- æ•°æ®æ²¡æœ‰ä¿å­˜ï¼Œæˆ–è€…ä¿å­˜äº†ä½†ç¼ºå°‘æŸäº›å­—æ®µ

---

### **åŸå›  2: Supabase Schema Cache æœªæ›´æ–°**

å³ä½¿æ•°æ®åº“è¡¨æœ‰è¿™äº›å­—æ®µï¼ŒSupabase çš„ API å±‚ï¼ˆPostgRESTï¼‰ä¹Ÿå¯èƒ½æ²¡æœ‰åˆ·æ–°ç¼“å­˜ã€‚

**ç—‡çŠ¶ï¼š**
- SQL ç¼–è¾‘å™¨ä¸­èƒ½çœ‹åˆ°å­—æ®µ
- å‰ç«¯æŸ¥è¯¢æ—¶æŠ¥é”™ "column not found in schema cache"
- éœ€è¦æ‰‹åŠ¨åˆ·æ–° API

---

## ğŸ› ï¸ **è§£å†³æ–¹æ¡ˆï¼ˆ3 æ­¥æå®šï¼‰**

### **ç¬¬ 1 æ­¥ï¼šè¿è¡Œè¯Šæ–­è„šæœ¬**

åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­è¿è¡Œï¼š

**æ–‡ä»¶ï¼š** `database/diagnose_missing_fields.sql`

è¿™ä¼šå‘Šè¯‰ä½ ï¼š
- âœ… å“ªäº›å­—æ®µå­˜åœ¨
- âŒ å“ªäº›å­—æ®µç¼ºå¤±
- ğŸ“Š å½“å‰æ•°æ®æƒ…å†µ

```sql
-- å¤åˆ¶ diagnose_missing_fields.sql çš„å†…å®¹åˆ° SQL ç¼–è¾‘å™¨
-- ç‚¹å‡» Run æŒ‰é’®
```

---

### **ç¬¬ 2 æ­¥ï¼šè¿è¡Œä¿®å¤è„šæœ¬**

åœ¨ Supabase SQL ç¼–è¾‘å™¨ä¸­è¿è¡Œï¼š

**æ–‡ä»¶ï¼š** `database/fix_all_missing_fields.sql`

è¿™ä¼šï¼š
- âœ… è‡ªåŠ¨æ·»åŠ æ‰€æœ‰ç¼ºå¤±çš„å­—æ®µ
- ğŸ”„ åˆ·æ–° Supabase schema cache
- âœ… éªŒè¯ä¿®å¤ç»“æœ

```sql
-- å¤åˆ¶ fix_all_missing_fields.sql çš„å†…å®¹åˆ° SQL ç¼–è¾‘å™¨
-- ç‚¹å‡» Run æŒ‰é’®
```

**é¢„æœŸè¾“å‡ºï¼š**

```
âœ… å·²æ·»åŠ  date å­—æ®µ
âœ… å·²æ·»åŠ  subject å­—æ®µ
âœ… å·²æ·»åŠ  location å­—æ®µ
...
ğŸ‰ æ‰€æœ‰å­—æ®µå·²æ£€æŸ¥å¹¶æ·»åŠ å®Œæˆï¼
```

---

### **ç¬¬ 3 æ­¥ï¼šåˆ·æ–°å‰ç«¯**

1. **å®Œå…¨åˆ·æ–°æµè§ˆå™¨**
   - Windows: `Ctrl + Shift + R`
   - Mac: `Cmd + Shift + R`

2. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**
   - æŒ‰ `F12` æ‰“å¼€å¼€å‘è€…å·¥å…·
   - å³é”®ç‚¹å‡»åˆ·æ–°æŒ‰é’®
   - é€‰æ‹© "æ¸…ç©ºç¼“å­˜å¹¶ç¡¬æ€§é‡æ–°åŠ è½½"

3. **å¦‚æœè¿˜ä¸è¡Œï¼Œé‡å¯ Supabase API**
   - è®¿é—® Supabase Dashboard
   - ç‚¹å‡» `Settings` â†’ `API`
   - ç‚¹å‡» `Restart now` æŒ‰é’®

---

## ğŸ“Š **éªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸ**

### æ–¹æ³• 1: åœ¨ SQL ç¼–è¾‘å™¨éªŒè¯

```sql
-- æŸ¥çœ‹è¡¨ç»“æ„
SELECT column_name, data_type, is_nullable
FROM information_schema.columns
WHERE table_schema = 'public' 
  AND table_name = 'badcases'
ORDER BY ordinal_position;

-- åº”è¯¥çœ‹åˆ°æ‰€æœ‰å­—æ®µï¼š
-- id, date, subject, location, full_tts_lesson_id, cms_id,
-- reporter, category, expected_fix_date, status, description,
-- audio_url, model_id, created_at, updated_at
```

### æ–¹æ³• 2: åœ¨å‰ç«¯éªŒè¯

1. **æ‰“å¼€åº”ç”¨** `http://localhost:5173`
2. **æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å°**ï¼ˆF12ï¼‰
3. **æ–°å»ºä¸€æ¡ Badcase**ï¼Œå¡«å†™æ‰€æœ‰å­—æ®µ
4. **æäº¤**
5. **æŸ¥çœ‹æ§åˆ¶å°**ï¼Œåº”è¯¥æ˜¾ç¤ºï¼š

```
âœ… Badcase åˆ›å»ºæˆåŠŸ: BC0005
æ”¶åˆ°æ•°æ®åº“å˜åŒ–: Object {
  eventType: "INSERT",
  new: {
    id: "BC0005",
    date: "2025-12-23",
    subject: "è¯­æ–‡",
    reporter: "æ¨ç›ç‰",
    ...
  }
}
```

6. **åˆ·æ–°é¡µé¢æˆ–æ‰“å¼€å¦ä¸€ä¸ªæµè§ˆå™¨çª—å£**
7. **åº”è¯¥èƒ½çœ‹åˆ°åˆšæ‰å¡«å†™çš„æ‰€æœ‰å­—æ®µ**

---

## ğŸ” **æ·±å…¥ç†è§£ï¼šä¸ºä»€ä¹ˆä¼šå‘ç”Ÿè¿™ä¸ªé—®é¢˜ï¼Ÿ**

### **åœºæ™¯ 1: æ•°æ®åº“è¡¨åˆ›å»ºä¸å®Œæ•´**

å¦‚æœæœ€åˆåˆ›å»º `badcases` è¡¨æ—¶åªåŒ…å«äº†éƒ¨åˆ†å­—æ®µï¼š

```sql
-- æ—§çš„è¡¨ç»“æ„ï¼ˆä¸å®Œæ•´ï¼‰
CREATE TABLE badcases (
  id TEXT PRIMARY KEY,
  category TEXT NOT NULL,
  status TEXT NOT NULL,
  description TEXT NOT NULL
  -- ç¼ºå°‘ date, subject, reporter ç­‰å­—æ®µï¼
);
```

åæ¥å‰ç«¯ä»£ç æ·»åŠ äº†æ–°å­—æ®µï¼Œä½†æ•°æ®åº“è¡¨æ²¡æœ‰æ›´æ–°ï¼Œå°±ä¼šå¯¼è‡´ï¼š
- **å†™å…¥å¤±è´¥**ï¼š`date` å­—æ®µä¸å­˜åœ¨
- **æŸ¥è¯¢å¤±è´¥**ï¼š`SELECT date` æ‰¾ä¸åˆ°å­—æ®µ

---

### **åœºæ™¯ 2: Schema Cache æœªåˆ·æ–°**

Supabase ä½¿ç”¨ PostgREST ä½œä¸º API å±‚ï¼Œå®ƒä¼šç¼“å­˜æ•°æ®åº“ç»“æ„ä»¥æé«˜æ€§èƒ½ã€‚

å³ä½¿ä½ æ‰‹åŠ¨åœ¨ SQL ç¼–è¾‘å™¨ä¸­æ·»åŠ äº†å­—æ®µï¼š

```sql
ALTER TABLE badcases ADD COLUMN date TEXT;
```

PostgREST çš„ç¼“å­˜ä¸ä¼šè‡ªåŠ¨æ›´æ–°ï¼Œå¯¼è‡´å‰ç«¯ API è¯·æ±‚æ—¶ä»ç„¶æ‰¾ä¸åˆ° `date` å­—æ®µã€‚

**è§£å†³æ–¹æ³•ï¼š** å‘é€ `NOTIFY pgrst, 'reload schema'` ä¿¡å·å¼ºåˆ¶åˆ·æ–°ã€‚

---

## ğŸ“ **å®Œæ•´çš„å­—æ®µåˆ—è¡¨**

æ ¹æ®ä½ çš„å‰ç«¯ä»£ç  (`src/types/index.ts`)ï¼Œ`badcases` è¡¨åº”è¯¥åŒ…å«ä»¥ä¸‹å­—æ®µï¼š

| å­—æ®µå | æ•°æ®ç±»å‹ | æ˜¯å¦å¿…å¡« | è¯´æ˜ |
|--------|---------|---------|------|
| `id` | TEXT | âœ… | ä¸»é”®ï¼Œå¦‚ BC0001 |
| `date` | TEXT | âœ… | æ—¥æœŸï¼Œå¦‚ 2025-12-23 |
| `subject` | TEXT | âŒ | å­¦ç§‘ï¼šè¯­æ–‡ã€æ•°å­¦ã€è‹±è¯­ |
| `location` | TEXT | âŒ | ä½ç½®ï¼šfullTTS æˆ– interactive |
| `full_tts_lesson_id` | TEXT | âŒ | å…¨ç¨‹TTSè¯¾èŠ‚ID |
| `cms_id` | TEXT | âŒ | CMSè¯¾ç¨‹/è¯¾èŠ‚ID |
| `reporter` | TEXT | âŒ | ææŠ¥äººå§“å |
| `category` | TEXT | âœ… | é—®é¢˜ç±»åˆ« |
| `expected_fix_date` | TEXT | âœ… | æœŸæœ›ä¿®å¤æ—¶é—´ |
| `status` | TEXT | âœ… | çŠ¶æ€ï¼špending/processing/resolved |
| `description` | TEXT | âœ… | é—®é¢˜æè¿° |
| `audio_url` | TEXT | âŒ | éŸ³é¢‘æ–‡ä»¶URL |
| `model_id` | TEXT | âŒ | æ¨¡å‹ID |
| `created_at` | TIMESTAMPTZ | è‡ªåŠ¨ | åˆ›å»ºæ—¶é—´ |
| `updated_at` | TIMESTAMPTZ | è‡ªåŠ¨ | æ›´æ–°æ—¶é—´ |

---

## ğŸš¨ **å¸¸è§é”™è¯¯ä¿¡æ¯å¯¹ç…§**

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ³• |
|---------|------|---------|
| `Could not find the 'date' column` | è¡¨ç¼ºå°‘ `date` å­—æ®µ | è¿è¡Œ `fix_all_missing_fields.sql` |
| `column "subject" does not exist` | è¡¨ç¼ºå°‘ `subject` å­—æ®µ | è¿è¡Œ `fix_all_missing_fields.sql` |
| `null value in column "date" violates not-null constraint` | `date` å­—æ®µä¸ºç©ºä½†è®¾ç½®äº† NOT NULL | æ£€æŸ¥å‰ç«¯æ˜¯å¦ä¼ å€¼ |
| `Schema cache is stale` | PostgREST ç¼“å­˜æœªæ›´æ–° | è¿è¡Œ `NOTIFY pgrst, 'reload schema';` |

---

## âœ… **æ“ä½œæ£€æŸ¥æ¸…å•**

å®Œæˆä»¥ä¸‹æ­¥éª¤ï¼Œç¡®ä¿é—®é¢˜è§£å†³ï¼š

- [ ] åœ¨ Supabase SQL ç¼–è¾‘å™¨è¿è¡Œ `diagnose_missing_fields.sql`
- [ ] ç¡®è®¤å“ªäº›å­—æ®µç¼ºå¤±
- [ ] åœ¨ Supabase SQL ç¼–è¾‘å™¨è¿è¡Œ `fix_all_missing_fields.sql`
- [ ] éªŒè¯æ‰€æœ‰å­—æ®µå·²æ·»åŠ 
- [ ] åˆ·æ–° Supabase APIï¼ˆSettings â†’ API â†’ Restart nowï¼‰
- [ ] å¼ºåˆ¶åˆ·æ–°å‰ç«¯æµè§ˆå™¨ï¼ˆCmd + Shift + Rï¼‰
- [ ] æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- [ ] æ–°å»ºä¸€æ¡æµ‹è¯•æ•°æ®ï¼Œå¡«å†™æ‰€æœ‰å­—æ®µ
- [ ] åœ¨å¦ä¸€ä¸ªæµè§ˆå™¨çª—å£éªŒè¯æ•°æ®å¯è§
- [ ] æ‰“å¼€æ§åˆ¶å°ï¼Œç¡®è®¤æ²¡æœ‰é”™è¯¯

---

## ğŸ“ **é¢„é˜²æœªæ¥çš„ç±»å‹é—®é¢˜**

### 1. ä½¿ç”¨å®Œæ•´çš„å»ºè¡¨è„šæœ¬

ç¡®ä¿ä½¿ç”¨ `database/create_badcases_table.sql` åˆ›å»ºè¡¨ï¼Œå®ƒåŒ…å«æ‰€æœ‰å¿…éœ€å­—æ®µã€‚

### 2. å‰åç«¯å­—æ®µåŒæ­¥

- **å‰ç«¯æ·»åŠ æ–°å­—æ®µ** â†’ åŒæ—¶æ›´æ–°æ•°æ®åº“è¡¨
- **æ•°æ®åº“æ·»åŠ æ–°å­—æ®µ** â†’ åŒæ—¶æ›´æ–°å‰ç«¯ç±»å‹å®šä¹‰

### 3. å®šæœŸåˆ·æ–° Schema Cache

åœ¨ä¿®æ”¹è¡¨ç»“æ„åï¼Œå§‹ç»ˆè¿è¡Œï¼š

```sql
NOTIFY pgrst, 'reload schema';
```

---

## ğŸ“ **éœ€è¦å¸®åŠ©ï¼Ÿ**

å¦‚æœæŒ‰ç…§ä¸Šè¿°æ­¥éª¤ä»ç„¶æ— æ³•è§£å†³ï¼š

1. **æŸ¥çœ‹å®Œæ•´é”™è¯¯æ—¥å¿—**
   - æµè§ˆå™¨æ§åˆ¶å°ï¼ˆF12ï¼‰
   - Supabase Dashboard â†’ Logs

2. **æ£€æŸ¥ Supabase è¡¨ç»“æ„**
   - Supabase Dashboard â†’ Database â†’ Tables â†’ badcases
   - æŸ¥çœ‹æ˜¯å¦æœ‰æ‰€æœ‰å­—æ®µ

3. **è¿è¡Œè¯Šæ–­è„šæœ¬**
   - `diagnose_missing_fields.sql`
   - æˆªå›¾ç»“æœå‘ç»™æŠ€æœ¯æ”¯æŒ

---

**ç¥ä½ é¡ºåˆ©è§£å†³é—®é¢˜ï¼** ğŸ‰

