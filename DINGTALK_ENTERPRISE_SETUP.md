# 钉钉企业内部应用机器人配置指南

本指南帮助你配置钉钉企业内部应用机器人，实现在群聊中提报Badcase。

---

## 📋 前置条件

- ✅ 已有钉钉企业账号
- ✅ 有企业管理员权限
- ✅ 已部署项目到Vercel
- ✅ 已配置Supabase数据库

---

## 🔧 第一步：创建企业内部应用

### 1.1 登录钉钉开放平台

访问：https://open.dingtalk.com/

使用企业管理员账号登录。

### 1.2 创建应用

1. 点击顶部 **应用开发** → **企业内部开发**
2. 点击 **创建应用**
3. 填写应用信息：
   - **应用名称**：Badcase提报助手
   - **应用描述**：智能Badcase提报和管理
   - **应用图标**：上传一个图标（可选）
4. 点击 **确认创建**

### 1.3 记录应用凭证

创建成功后，在 **应用信息** 页面记录：

```
AppKey (Client ID): xxxxxxxxxxxx
AppSecret (Client Secret): xxxxxxxxxxxxxxxxxxxx
AgentId: xxxxxxxxxxxx
```

⚠️ **重要**：这些信息稍后需要配置到Vercel环境变量中。

---

## 🤖 第二步：配置机器人

### 2.1 添加机器人功能

1. 在应用管理页面，点击左侧 **机器人与消息推送**
2. 点击 **开启机器人配置**
3. 填写机器人信息：
   - **机器人名称**：Badcase助手
   - **机器人头像**：上传图标（可选）
   - **消息接收模式**：选择 **HTTP模式**（不是Stream模式！）

### 2.2 配置消息接收地址

在 **消息接收地址** 填入：

```
https://your-project.vercel.app/api/dingtalk-bot
```

将 `your-project.vercel.app` 替换为你的Vercel项目域名。

### 2.3 配置安全设置

钉钉会要求验证你的接收地址：

1. 系统会发送验证请求到你的URL
2. 你需要正确响应验证（代码已处理）
3. 验证通过后点击 **保存**

---

## 🔑 第三步：配置Vercel环境变量

### 3.1 登录Vercel

访问：https://vercel.com

进入你的项目：`voice-badcase-platform`

### 3.2 添加环境变量

点击 **Settings** → **Environment Variables**，添加以下变量：

#### 必填变量：

| 变量名 | 说明 | 示例值 |
|--------|------|--------|
| `DINGTALK_APP_KEY` | 应用的AppKey | `dingxxxxxxxxxxxx` |
| `DINGTALK_APP_SECRET` | 应用的AppSecret | `xxxxxxxxxxxxxxxxxx` |
| `DINGTALK_AGENT_ID` | 机器人AgentId | `123456789` |

#### 可选变量（用于主动推送）：

| 变量名 | 说明 | 如何获取 |
|--------|------|----------|
| `DINGTALK_WEBHOOK` | 群机器人Webhook URL | 在群设置中添加自定义机器人获取 |
| `DINGTALK_SECRET` | 群机器人密钥 | 添加自定义机器人时选择"加签"获取 |

### 3.3 保存并重新部署

添加完环境变量后：

1. 点击 **Save**
2. 返回 **Deployments** 页面
3. 点击 **Redeploy** 重新部署

---

## 🎯 第四步：添加机器人到群

### 4.1 打开钉钉群

打开你想要添加机器人的钉钉群。

### 4.2 添加机器人

1. 点击群设置（右上角 `...`）
2. 点击 **智能群助手** → **添加机器人**
3. 选择 **企业机器人** 标签
4. 找到你创建的 **Badcase助手**
5. 点击 **添加**

### 4.3 配置机器人权限

如果需要，可以配置：
- 是否@机器人才触发
- 哪些人可以使用
- 其他权限设置

---

## ✅ 第五步：测试功能

在钉钉群中发送测试消息：

```
@Badcase助手 提报问题
学科：英语
位置：行课互动
分类：读音错误
描述：A相关的单词发音不准确
提报人：测试人员
```

**期望结果**：

机器人应该在几秒内回复：

```
✅ Badcase提报成功！

ID: BC_XXXXXXXX_XXXXXXXX
学科: 英语
分类: 读音错误
提报人: 测试人员

已同步到平台，可前往查看详情。
```

---

## 🔍 故障排查

### 问题1：机器人没有响应

**检查清单**：

1. **验证环境变量**
   - 确认所有环境变量已添加到Vercel
   - 确认变量名拼写正确
   - 确认已重新部署

2. **查看Vercel日志**
   - Vercel Dashboard → Deployments → 点击最新部署
   - 查看 **Function Logs**
   - 看是否有错误信息

3. **检查消息接收地址**
   - 确认配置的URL正确
   - 确认URL验证已通过
   - 尝试手动访问URL测试

### 问题2：消息格式错误

确保消息格式正确：

✅ **正确格式**：
```
@Badcase助手 提报问题
学科：英语
分类：读音错误
描述：测试描述
```

❌ **错误格式**：
```
提报问题学科英语分类读音错误  （缺少换行和冒号）
```

### 问题3：验证地址失败

如果钉钉验证失败：

1. 确认代码已部署到Vercel
2. 确认URL可以访问
3. 查看Vercel函数日志，看验证请求是否收到
4. 可能需要等待1-2分钟让部署生效

---

## 📊 消息格式说明

### 必填字段

- **学科**：科目名称（例如：英语、数学）
- **分类**：问题类型（例如：读音错误、逻辑错误）
- **描述**：详细的问题描述

### 可选字段

- **位置**：问题出现位置（例如：行课互动、全流程TTS）
- **提报人**：提报人姓名
- **CMS课节ID**：课节编号
- **TTS课节ID**：TTS课节编号
- **模型ID**：问题模型ID
- **期望修复**：期望修复日期（格式：YYYY-MM-DD）

### 完整示例

```
@Badcase助手 提报问题
学科：英语
位置：行课互动
CMS课节ID：12345
分类：读音错误
描述：单词"apple"的发音不准确，听起来像"aple"
提报人：张三
期望修复：2025-12-30
```

---

## 🎨 使用技巧

### 技巧1：使用网页表单

为了避免格式错误，可以使用网页助手：

访问：`https://your-project.vercel.app/dingtalk-helper.html`

这个工具会：
- ✅ 自动生成标准格式
- ✅ 避免格式错误
- ✅ 一键复制到钉钉

### 技巧2：创建消息模板

可以在钉钉中保存常用的消息模板，使用时只需修改部分内容。

### 技巧3：批量提报

如果需要批量提报，可以：
1. 使用网页表单逐个提交
2. 或者准备CSV文件，通过网页批量导入功能

---

## 🔐 安全说明

### 环境变量保护

- ⚠️ **永远不要**将AppKey和AppSecret提交到Git
- ⚠️ **只在**Vercel环境变量中配置
- ⚠️ **定期更新**密钥以提高安全性

### 消息验证

代码会自动验证：
- ✅ 消息签名（防止伪造）
- ✅ 时间戳（防止重放攻击）
- ✅ 消息格式（防止注入攻击）

### 权限控制

建议配置：
- 限制机器人只在特定群使用
- 限制特定人员才能提报
- 开启消息审核（如果需要）

---

## 📞 获取帮助

如果遇到问题：

1. **查看日志**
   - Vercel函数日志
   - 钉钉开放平台的调试日志

2. **参考文档**
   - [钉钉开放平台文档](https://open.dingtalk.com/document/)
   - [Vercel部署文档](https://vercel.com/docs)

3. **联系支持**
   - 项目GitHub Issues
   - 钉钉开放平台工单

---

## 🎉 完成！

配置完成后，你的团队就可以：
- ✅ 在钉钉群中快速提报Badcase
- ✅ 自动同步到管理平台
- ✅ 实时接收提报确认
- ✅ 统一管理所有问题

祝使用愉快！🚀

