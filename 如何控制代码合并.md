# 🔐 如何控制团队成员的代码合并

## 📌 你想要的效果

✅ 团队成员可以编写代码、推送到 GitHub  
✅ 但**必须经过你的审查批准**才能合并到主分支  
✅ 你可以审查代码、提出修改意见  
✅ 你批准后才能合并  

**好消息**：不需要动态密码，GitHub 自带这个功能！

---

## 🎯 实现方式：分支保护 + PR 审查

### 工作流程图：

```
团队成员 A:
  编写代码 → 推送到分支 → 创建 PR
                              ↓
                          等待你审查
                              ↓
你（项目负责人）:               ↓
  收到通知 → 审查代码 → 提意见/批准
                              ↓
                          ✅ 你批准
                              ↓
                        代码合并到 main
```

### 关键点：

1. 团队成员**可以推送**，但只能推送到**自己的功能分支**
2. 他们**不能直接推送到 `main` 分支**
3. 必须创建 **Pull Request**
4. **你审查并批准后**，代码才能合并

---

## ⚙️ 详细配置步骤（5分钟）

### 第一步：配置分支保护规则

1. **打开你的 GitHub 仓库**  
   https://github.com/Camelia-star-98/voice-badcase-platform

2. **进入设置**  
   点击顶部的 **Settings**（设置）

3. **进入分支设置**  
   左侧菜单找到 **Branches**（分支）

4. **添加保护规则**  
   点击 **Add branch protection rule**（添加分支保护规则）

5. **配置规则**：

   ```
   Branch name pattern（分支名称）:
   ┌─────────────────────────────┐
   │ main                        │  ← 输入这个
   └─────────────────────────────┘

   勾选以下选项：

   ☑️ Require a pull request before merging
      （合并前需要 Pull Request）
      
      ☑️ Require approvals
         （需要审批）
         
         Required number of approvals: [1]  ← 设置为 1（就是你）

      ☑️ Dismiss stale pull request approvals when new commits are pushed
         （有新提交时取消之前的批准）

      ☐ Require review from Code Owners
         （可选，暂时不勾）

   ☐ Require status checks to pass before merging
      （可选，如果有 CI/CD 再勾）

   ☐ Require conversation resolution before merging
      （可选：要求解决所有评论）

   ☑️ Require linear history
      （推荐：保持历史线性）

   ☐ Require deployments to succeed before merging
      （不需要）

   ☐ Lock branch
      （不要勾！会锁死分支）

   ☑️ Do not allow bypassing the above settings
      （不允许绕过规则 - 包括你自己！）
      或者
   ☐ Allow specified actors to bypass required pull requests
      （允许特定人员绕过 - 你可以把自己加进去，紧急情况用）

   ☐ Allow force pushes
      （不推荐，除非你很清楚在做什么）

   ☐ Allow deletions
      （不推荐）
   ```

6. **保存**  
   滚动到底部，点击 **Create**（创建）

---

## ✅ 配置完成后的效果

### 团队成员的操作流程：

```bash
# 1. 克隆项目（第一次）
git clone https://github.com/Camelia-star-98/voice-badcase-platform.git
cd voice-badcase-platform

# 2. 创建功能分支
git checkout -b feature/add-search

# 3. 编写代码
# ... 修改文件 ...

# 4. 提交代码
git add .
git commit -m "feat: 添加搜索功能"

# 5. 推送到 GitHub（推送到他们自己的分支，不是 main）
git push origin feature/add-search
# ✅ 这一步可以成功

# 6. 尝试推送到 main（会被阻止）
git push origin main
# ❌ 错误！显示：main is protected
```

### 他们会收到提示：

```
! [remote rejected] main -> main (protected branch hook declined)
error: failed to push some refs
```

### 他们必须做的：

1. 推送到自己的分支 ✅
2. 在 GitHub 上创建 **Pull Request**
3. 等待你审查和批准
4. 你批准后才能点击 "Merge" 合并

---

## 👀 你作为负责人的审查流程

### 1. 收到 PR 通知

团队成员创建 PR 后，你会收到：
- 📧 **GitHub 邮件通知**
- 🔔 **GitHub 网站通知**（右上角铃铛图标）

### 2. 审查代码

点击通知进入 PR 页面，你会看到：

- **Files changed** 标签：查看修改了哪些文件
- 红色：删除的代码
- 绿色：新增的代码

### 3. 提出意见或批准

#### 选项 A：需要修改

在代码行旁边点击 **+** 号，添加评论：

```
这里的逻辑有问题，应该这样写：
[你的建议]
```

然后选择：**Request changes**（要求修改）

团队成员会收到通知，修改后会推送新的提交。

#### 选项 B：批准合并

如果代码没问题，点击 **Review changes** → **Approve**（批准）

然后他们（或你）就可以点击绿色的 **Merge pull request** 按钮了。

---

## 🔒 三种权限级别对比

### 方案 1：宽松模式（不推荐）

```
不配置分支保护
→ 任何人都能直接推送到 main
→ ❌ 你无法控制
```

### 方案 2：标准模式（推荐 ⭐）

```
分支保护 + 需要 1 人批准
→ 必须通过 PR
→ 你审查后才能合并
→ ✅ 你有控制权，但紧急情况下你也能快速处理
```

**配置**：
- ☑️ Require PR
- ☑️ Require 1 approval
- ☐ 不要勾 "Do not allow bypassing"（让你自己能紧急合并）

### 方案 3：严格模式

```
分支保护 + 强制审查 + 不允许绕过
→ 连你自己也必须创建 PR
→ ✅ 最安全，但可能影响紧急修复速度
```

**配置**：
- ☑️ Require PR
- ☑️ Require 1 approval
- ☑️ Do not allow bypassing（连管理员也不能绕过）

**推荐：使用方案 2（标准模式）** - 既有控制权，又保留灵活性

---

## 📱 实际操作示例

### 场景：团队成员小李要添加新功能

#### 第1步：小李创建分支并编写代码

```bash
git checkout -b feature/user-search
# 编写代码...
git add .
git commit -m "feat: 添加用户搜索功能"
git push origin feature/user-search
```

#### 第2步：小李在 GitHub 创建 PR

1. 打开仓库页面
2. 会看到提示：**Compare & pull request**
3. 填写 PR 描述：
   ```
   ## 功能说明
   添加了用户搜索功能
   
   ## 改动内容
   - 新增搜索框组件
   - 添加搜索 API 调用
   - 更新列表过滤逻辑
   
   ## 测试
   - [x] 本地测试通过
   - [x] 无控制台错误
   ```
4. 点击 **Create pull request**

#### 第3步：你收到通知

📧 邮件：**[voice-badcase-platform] Pull Request #1: 添加用户搜索功能**

#### 第4步：你审查代码

1. 点击邮件中的链接
2. 查看 **Files changed**
3. 发现一个小问题，添加评论：
   ```
   这里应该加个 loading 状态，避免重复点击
   ```
4. 点击 **Request changes**

#### 第5步：小李修改代码

```bash
# 在原分支继续修改
git add .
git commit -m "fix: 添加 loading 状态"
git push origin feature/user-search
```

PR 会自动更新，你会再次收到通知。

#### 第6步：你批准并合并

1. 查看新的提交
2. 点击 **Review changes** → **Approve**
3. 点击绿色的 **Merge pull request**
4. 确认合并

✅ 代码合并到 main，你可以通知小李拉取最新代码：

```bash
git checkout main
git pull origin main
```

---

## ❓ 常见问题

### Q1: 如果我不在，团队卡住了怎么办？

**方案 A**：添加备用审查者

在团队里再指定 1-2 个可信任的人，配置时：
- 将他们也设为仓库管理员
- 或者在 "Required approvals" 设置中，允许其他人也能审查

**方案 B**：临时允许绕过（紧急情况）

你可以把信任的成员加入 bypass 列表：
```
☑️ Allow specified actors to bypass required pull requests
   → 添加可信任成员的用户名
```

### Q2: 我自己开发时也要走 PR 流程吗？

取决于你的配置：

**选项 A**：你可以绕过（推荐）
- 不勾 "Do not allow bypassing"
- 作为管理员，你可以直接推送到 main

**选项 B**：严格模式
- 勾选 "Do not allow bypassing"
- 你也必须走 PR 流程
- 可以防止你自己误操作

### Q3: 团队成员可以自己合并 PR 吗？

**取决于你的配置**：

如果你设置了 "Require 1 approval"：
- 团队成员创建 PR 后**不能自己批准**
- 必须等你（或其他有权限的人）批准
- 批准后，他们可以点击 "Merge" 按钮
- 或者你也可以直接帮他们合并

### Q4: 和动态密码有什么区别？

**动态密码**（不需要）：
- 是指 GitHub 的 Personal Access Token
- 用于身份验证（证明你是谁）
- 团队成员已经有自己的 GitHub 账号和权限

**分支保护**（你需要的）：
- 控制谁能合并代码
- 强制代码审查流程
- 不需要额外的密码

### Q5: 如何撤销某人的推送权限？

1. Settings → Collaborators
2. 找到该成员
3. 点击旁边的 **Remove**（移除）

他们将无法再推送任何代码。

---

## 🎯 推荐配置（复制粘贴清单）

### ✅ 适合小团队的配置

进入 Settings → Branches → Add rule：

```
Branch name pattern: main

勾选：
☑️ Require a pull request before merging
   ☑️ Require approvals: 1
   ☑️ Dismiss stale pull request approvals when new commits are pushed

☑️ Require linear history

不勾选：
☐ Do not allow bypassing （让你能直接推送，紧急情况用）
☐ Allow force pushes
☐ Allow deletions
```

点击 **Create**

---

## 📞 配置完成后的检查

配置完成后，让团队成员测试：

```bash
# 让他们尝试直接推送到 main（应该会失败）
git push origin main
# 应该看到：remote: error: GH006: Protected branch update failed

# 然后让他们走正确流程：
git checkout -b test/check-protection
echo "test" > test.txt
git add test.txt
git commit -m "test: 测试分支保护"
git push origin test/check-protection
# 应该成功，然后让他们在 GitHub 创建 PR
```

如果看到保护错误 ✅ 说明配置成功！

---

## 🎉 总结

**你需要的不是动态密码，而是分支保护！**

配置后的效果：
- ✅ 团队成员可以开发和推送代码
- ✅ 但不能直接改 main 分支
- ✅ 必须创建 PR 等你审查
- ✅ 你批准后才能合并
- ✅ 你保持对代码库的完全控制

**5 分钟配置，终身受益！**

按照上面的步骤配置即可，有问题随时问我！🚀

