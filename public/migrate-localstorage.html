<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®è¿ç§»å·¥å…· - LocalStorage åˆ° Supabase</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      max-width: 800px;
      margin: 50px auto;
      padding: 20px;
      background: #f5f5f5;
    }
    .container {
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    h1 {
      color: #333;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #666;
      margin-bottom: 30px;
    }
    .section {
      margin-bottom: 30px;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      border-left: 4px solid #4CAF50;
    }
    .data-preview {
      background: #fff;
      padding: 15px;
      border-radius: 5px;
      border: 1px solid #ddd;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    button {
      background: #4CAF50;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 16px;
      border-radius: 5px;
      cursor: pointer;
      margin-right: 10px;
    }
    button:hover {
      background: #45a049;
    }
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .danger {
      background: #f44336;
    }
    .danger:hover {
      background: #da190b;
    }
    .info {
      background: #2196F3;
    }
    .info:hover {
      background: #0b7dda;
    }
    .status {
      padding: 10px;
      margin-top: 15px;
      border-radius: 5px;
      display: none;
    }
    .status.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }
    .status.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }
    .status.info {
      background: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
      display: block;
    }
    .count {
      font-size: 24px;
      font-weight: bold;
      color: #4CAF50;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”„ æ•°æ®è¿ç§»å·¥å…·</h1>
    <p class="subtitle">å°† localStorage ä¸­çš„æ•°æ®è¿ç§»åˆ° Supabase æ•°æ®åº“</p>

    <!-- æ­¥éª¤ 1: æ£€æŸ¥ localStorage -->
    <div class="section">
      <h3>ğŸ“Š æ­¥éª¤ 1: æ£€æŸ¥æœ¬åœ°æ•°æ®</h3>
      <button onclick="checkLocalStorage()">æ£€æŸ¥ localStorage æ•°æ®</button>
      <div id="localStatus" class="status"></div>
      <div class="count" id="localCount" style="display:none;"></div>
      <div id="localPreview" class="data-preview" style="display:none;"></div>
    </div>

    <!-- æ­¥éª¤ 2: è¿æ¥ Supabase -->
    <div class="section">
      <h3>ğŸ”Œ æ­¥éª¤ 2: è¿æ¥ Supabase</h3>
      <button onclick="testSupabaseConnection()" class="info">æµ‹è¯• Supabase è¿æ¥</button>
      <div id="supabaseStatus" class="status"></div>
    </div>

    <!-- æ­¥éª¤ 3: è¿ç§»æ•°æ® -->
    <div class="section">
      <h3>ğŸš€ æ­¥éª¤ 3: è¿ç§»æ•°æ®</h3>
      <button onclick="migrateData()" id="migrateBtn" disabled>å¼€å§‹è¿ç§»</button>
      <button onclick="clearLocalStorage()" class="danger" id="clearBtn" disabled>æ¸…ç©º localStorageï¼ˆè¿ç§»æˆåŠŸåï¼‰</button>
      <div id="migrateStatus" class="status"></div>
    </div>
  </div>

  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

    const SUPABASE_URL = 'https://mcpyilgpotajpmgblorc.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1jcHlpbGdwb3RhanBtZ2Jsb3JjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYzODUxNzMsImV4cCI6MjA4MTk2MTE3M30.mmVnFh6uDlRdlOKmtKQSd2WnLBKd4ApE4OWqIMu-41c';

    let supabase;
    let localData = [];
    let isConnected = false;

    // åˆå§‹åŒ– Supabase
    try {
      supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      console.log('âœ… Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–');
    } catch (error) {
      console.error('âŒ Supabase å®¢æˆ·ç«¯åˆå§‹åŒ–å¤±è´¥:', error);
    }

    // æ£€æŸ¥ localStorage
    window.checkLocalStorage = function() {
      const statusDiv = document.getElementById('localStatus');
      const countDiv = document.getElementById('localCount');
      const previewDiv = document.getElementById('localPreview');

      try {
        const savedData = localStorage.getItem('badcaseList');
        
        if (!savedData) {
          statusDiv.className = 'status info';
          statusDiv.textContent = 'âš ï¸ localStorage ä¸­æ²¡æœ‰æ‰¾åˆ°æ•°æ®';
          countDiv.style.display = 'none';
          previewDiv.style.display = 'none';
          return;
        }

        localData = JSON.parse(savedData);
        
        if (localData.length === 0) {
          statusDiv.className = 'status info';
          statusDiv.textContent = 'âš ï¸ localStorage ä¸­çš„æ•°æ®ä¸ºç©º';
          countDiv.style.display = 'none';
          previewDiv.style.display = 'none';
          return;
        }

        statusDiv.className = 'status success';
        statusDiv.textContent = `âœ… æˆåŠŸè¯»å– localStorage æ•°æ®`;
        
        countDiv.textContent = `æ‰¾åˆ° ${localData.length} æ¡è®°å½•`;
        countDiv.style.display = 'block';
        
        previewDiv.textContent = JSON.stringify(localData, null, 2);
        previewDiv.style.display = 'block';

        console.log('âœ… localStorage æ•°æ®:', localData);
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = `âŒ è¯»å–å¤±è´¥: ${error.message}`;
        countDiv.style.display = 'none';
        previewDiv.style.display = 'none';
      }
    };

    // æµ‹è¯• Supabase è¿æ¥
    window.testSupabaseConnection = async function() {
      const statusDiv = document.getElementById('supabaseStatus');
      const migrateBtn = document.getElementById('migrateBtn');

      try {
        statusDiv.className = 'status info';
        statusDiv.textContent = 'ğŸ”„ æ­£åœ¨è¿æ¥ Supabase...';

        // æµ‹è¯•æŸ¥è¯¢
        const { data, error, count } = await supabase
          .from('badcases')
          .select('*', { count: 'exact' });

        if (error) throw error;

        isConnected = true;
        statusDiv.className = 'status success';
        statusDiv.textContent = `âœ… Supabase è¿æ¥æˆåŠŸï¼å½“å‰æ•°æ®åº“ä¸­æœ‰ ${count || 0} æ¡è®°å½•`;
        
        migrateBtn.disabled = localData.length === 0;
        
        console.log('âœ… Supabase å½“å‰æ•°æ®:', data);
      } catch (error) {
        isConnected = false;
        statusDiv.className = 'status error';
        statusDiv.textContent = `âŒ è¿æ¥å¤±è´¥: ${error.message}`;
        migrateBtn.disabled = true;
        console.error('âŒ Supabase è¿æ¥é”™è¯¯:', error);
      }
    };

    // è¿ç§»æ•°æ®
    window.migrateData = async function() {
      const statusDiv = document.getElementById('migrateStatus');
      const migrateBtn = document.getElementById('migrateBtn');
      const clearBtn = document.getElementById('clearBtn');

      if (!isConnected) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âŒ è¯·å…ˆæµ‹è¯• Supabase è¿æ¥';
        return;
      }

      if (localData.length === 0) {
        statusDiv.className = 'status error';
        statusDiv.textContent = 'âŒ æ²¡æœ‰æ•°æ®éœ€è¦è¿ç§»';
        return;
      }

      try {
        migrateBtn.disabled = true;
        statusDiv.className = 'status info';
        statusDiv.textContent = `ğŸ”„ æ­£åœ¨è¿ç§» ${localData.length} æ¡æ•°æ®...`;

        // æ‰¹é‡æ’å…¥æ•°æ®
        const { data, error } = await supabase
          .from('badcases')
          .insert(localData)
          .select();

        if (error) throw error;

        statusDiv.className = 'status success';
        statusDiv.textContent = `âœ… æˆåŠŸè¿ç§» ${data.length} æ¡æ•°æ®åˆ° Supabaseï¼`;
        
        clearBtn.disabled = false;
        
        console.log('âœ… è¿ç§»æˆåŠŸ:', data);
      } catch (error) {
        statusDiv.className = 'status error';
        statusDiv.textContent = `âŒ è¿ç§»å¤±è´¥: ${error.message}`;
        migrateBtn.disabled = false;
        console.error('âŒ è¿ç§»é”™è¯¯:', error);
      }
    };

    // æ¸…ç©º localStorage
    window.clearLocalStorage = function() {
      if (confirm('âš ï¸ ç¡®å®šè¦æ¸…ç©º localStorage å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼\n\nè¯·ç¡®ä¿æ•°æ®å·²æˆåŠŸè¿ç§»åˆ° Supabaseã€‚')) {
        localStorage.removeItem('badcaseList');
        
        const statusDiv = document.getElementById('migrateStatus');
        statusDiv.className = 'status success';
        statusDiv.textContent = 'âœ… localStorage å·²æ¸…ç©ºï¼ç°åœ¨å¯ä»¥åˆ·æ–°ä¸»åº”ç”¨ï¼Œæ•°æ®å°†ä» Supabase åŠ è½½ã€‚';
        
        document.getElementById('clearBtn').disabled = true;
        
        console.log('âœ… localStorage å·²æ¸…ç©º');
      }
    };

    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.addEventListener('load', () => {
      checkLocalStorage();
    });
  </script>
</body>
</html>

