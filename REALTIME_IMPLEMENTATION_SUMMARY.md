# ğŸ‰ Realtime å®æ—¶åŒæ­¥åŠŸèƒ½ - å®ç°æ€»ç»“

## é—®é¢˜æè¿°

ç”¨æˆ·åé¦ˆï¼š**åˆ«äººå¡«çš„ badcase æ²¡æœ‰å®æ—¶è¿›å…¥ç³»ç»Ÿ**

### åŸå› åˆ†æ

ç³»ç»Ÿä¹‹å‰åªåœ¨é¡µé¢åˆæ¬¡åŠ è½½æ—¶è·å–æ•°æ®ï¼Œåç»­æ²¡æœ‰ç›‘å¬æ•°æ®åº“çš„å˜åŒ–ï¼Œå¯¼è‡´ï¼š
- å…¶ä»–ç”¨æˆ·æ–°å¢çš„ badcase ä¸ä¼šè‡ªåŠ¨æ˜¾ç¤º
- å…¶ä»–ç”¨æˆ·çš„ç¼–è¾‘å’Œåˆ é™¤æ“ä½œä¹Ÿä¸å¯è§
- å¿…é¡»æ‰‹åŠ¨åˆ·æ–°é¡µé¢æ‰èƒ½çœ‹åˆ°æœ€æ–°æ•°æ®

---

## è§£å†³æ–¹æ¡ˆ

å®ç°äº† **Supabase Realtime** è®¢é˜…åŠŸèƒ½ï¼Œé€šè¿‡ WebSocket å®æ—¶ç›‘å¬æ•°æ®åº“å˜åŒ–ã€‚

---

## ğŸ“ æ–‡ä»¶æ”¹åŠ¨

### 1. æ ¸å¿ƒä»£ç æ”¹åŠ¨

#### `src/api/supabase.ts`
```typescript
// æ–°å¢ Realtime é…ç½®
export const supabase = createClient(finalUrl, finalKey, {
  auth: {
    persistSession: false
  },
  realtime: {
    params: {
      eventsPerSecond: 10  // é™åˆ¶äº‹ä»¶é¢‘ç‡ï¼Œä¼˜åŒ–æ€§èƒ½
    }
  }
});
```

#### `src/contexts/BadcaseContext.tsx`
```typescript
// æ–°å¢ Realtime è®¢é˜…é€»è¾‘
useEffect(() => {
  if (!useSupabase) return;

  console.log('ğŸ”” å¯åŠ¨ Supabase Realtime è®¢é˜…...');

  const channel = supabase
    .channel('badcases-changes')
    .on('postgres_changes', {
      event: '*',        // ç›‘å¬æ‰€æœ‰äº‹ä»¶
      schema: 'public',
      table: 'badcases',
    }, (payload) => {
      console.log('ğŸ”” æ”¶åˆ°æ•°æ®åº“å˜åŒ–:', payload);
      
      switch (payload.eventType) {
        case 'INSERT':
          // æ·»åŠ æ–°æ•°æ®åˆ°æœ¬åœ°çŠ¶æ€
          break;
        case 'UPDATE':
          // æ›´æ–°æœ¬åœ°çŠ¶æ€
          break;
        case 'DELETE':
          // ä»æœ¬åœ°çŠ¶æ€åˆ é™¤
          break;
      }
    })
    .subscribe((status) => {
      if (status === 'SUBSCRIBED') {
        console.log('âœ… Realtime è®¢é˜…æˆåŠŸ');
      } else {
        console.error('âŒ Realtime è®¢é˜…å¤±è´¥:', status);
      }
    });

  // æ¸…ç†å‡½æ•°
  return () => {
    console.log('ğŸ”” æ¸…ç† Realtime è®¢é˜…');
    supabase.removeChannel(channel);
  };
}, [useSupabase]);
```

### 2. æ–°å¢æ–‡æ¡£

| æ–‡ä»¶ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `REALTIME_QUICK_START.md` | å¿«é€Ÿå‚è€ƒå¡ç‰‡ | 5åˆ†é’Ÿå¿«é€Ÿä¸Šæ‰‹ |
| `REALTIME_SETUP.md` | å®Œæ•´é…ç½®æŒ‡å— | è¯¦ç»†çš„è®¾ç½®æ­¥éª¤å’Œæ•…éšœæ’æŸ¥ |
| `TEST_REALTIME.md` | æµ‹è¯•æŒ‡å— | å¦‚ä½•éªŒè¯ Realtime åŠŸèƒ½ |
| `CHANGELOG.md` | æ›´æ–°æ—¥å¿— | è®°å½•æ‰€æœ‰æ”¹åŠ¨ |

### 3. æ–°å¢å·¥å…·

| æ–‡ä»¶ | è¯´æ˜ | ç”¨é€” |
|------|------|------|
| `test-realtime.html` | å¯è§†åŒ–æµ‹è¯•å·¥å…· | å®æ—¶ç›‘æ§æ•°æ®åº“äº‹ä»¶ |

### 4. æ›´æ–°æ–‡æ¡£

| æ–‡ä»¶ | æ”¹åŠ¨ |
|------|------|
| `README.md` | æ·»åŠ  Realtime åŠŸèƒ½ä»‹ç» |

---

## ğŸš€ éƒ¨ç½²æ­¥éª¤

### å¿…é¡»æ‰§è¡Œçš„æ­¥éª¤ï¼ˆä¸€æ¬¡æ€§ï¼‰

#### 1. åœ¨ Supabase å¯ç”¨ Realtime

**æ–¹æ³• 1: ä½¿ç”¨æ§åˆ¶å°**
1. è®¿é—® https://app.supabase.com
2. é€‰æ‹©ä½ çš„é¡¹ç›®
3. ç‚¹å‡» **Database** â†’ **Replication**
4. æ‰¾åˆ° `badcases` è¡¨
5. **å‹¾é€‰**å¤é€‰æ¡†
6. ä¿å­˜

**æ–¹æ³• 2: æ‰§è¡Œ SQL**
```sql
alter publication supabase_realtime add table badcases;
```

#### 2. éªŒè¯å¯ç”¨çŠ¶æ€

åœ¨ SQL Editor æ‰§è¡Œï¼š
```sql
SELECT tablename 
FROM pg_publication_tables 
WHERE pubname = 'supabase_realtime' 
  AND tablename = 'badcases';
```

åº”è¯¥è¿”å›ä¸€è¡Œç»“æœã€‚

### è‡ªåŠ¨éƒ¨ç½²

ä»£ç å·²ç»å‡†å¤‡å¥½ï¼Œæ¨é€åˆ° GitHub å Vercel ä¼šè‡ªåŠ¨éƒ¨ç½²ï¼š

```bash
git add .
git commit -m "feat: å®ç° Supabase Realtime å®æ—¶åŒæ­¥"
git push origin main
```

---

## ğŸ§ª æµ‹è¯•æ–¹æ³•

### æ–¹æ³• 1: åŒçª—å£æµ‹è¯•ï¼ˆæ¨èï¼‰

1. æ‰“å¼€ä¸¤ä¸ªæµè§ˆå™¨çª—å£ï¼š
   - çª—å£ A: https://voice-badcase-platform.vercel.app/
   - çª—å£ B: https://voice-badcase-platform.vercel.app/

2. åœ¨çª—å£ A æ–°å¢ä¸€ä¸ª badcase

3. è§‚å¯Ÿçª—å£ B â†’ **åº”è¯¥åœ¨ 1-2 ç§’å†…æ˜¾ç¤ºæ–°å¢çš„è®°å½•**

4. åœ¨çª—å£ A ç¼–è¾‘è¯¥ badcase

5. è§‚å¯Ÿçª—å£ B â†’ **åº”è¯¥ç«‹å³çœ‹åˆ°æ›´æ–°**

6. åœ¨çª—å£ A åˆ é™¤è¯¥ badcase

7. è§‚å¯Ÿçª—å£ B â†’ **åº”è¯¥ç«‹å³æ¶ˆå¤±**

### æ–¹æ³• 2: ä½¿ç”¨æµ‹è¯•å·¥å…·

1. åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ `test-realtime.html`

2. è¾“å…¥ Supabase URL å’Œ Key

3. è§‚å¯Ÿå®æ—¶æ—¥å¿—å’Œæ•°æ®å˜åŒ–

4. åœ¨ä¸»åº”ç”¨ä¸­æ“ä½œï¼ŒæŸ¥çœ‹æµ‹è¯•å·¥å…·çš„å®æ—¶åé¦ˆ

### æ–¹æ³• 3: æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—

æ‰“å¼€æµè§ˆå™¨æ§åˆ¶å° (F12)ï¼Œåº”è¯¥çœ‹åˆ°ï¼š

```
âœ… Supabase å®¢æˆ·ç«¯å·²åˆå§‹åŒ–
âœ… Supabase è¿æ¥æˆåŠŸ
ğŸ”” å¯åŠ¨ Supabase Realtime è®¢é˜…...
âœ… Realtime è®¢é˜…æˆåŠŸ
```

æ“ä½œæ—¶ä¼šæ˜¾ç¤ºï¼š
```
ğŸ”” æ”¶åˆ°æ•°æ®åº“å˜åŒ–: { eventType: 'INSERT', ... }
â• æ–°å¢ Badcase: BC0001
```

---

## âœ… éªŒæ”¶æ ‡å‡†

å®Œæˆä»¥ä¸‹æ‰€æœ‰æµ‹è¯•ï¼ŒåŠŸèƒ½å³ä¸ºæ­£å¸¸ï¼š

- [x] ä»£ç æ”¹åŠ¨å®Œæˆ
  - [x] `src/api/supabase.ts` - å¯ç”¨ Realtime é…ç½®
  - [x] `src/contexts/BadcaseContext.tsx` - å®ç°è®¢é˜…é€»è¾‘

- [ ] åœ¨ Supabase å¯ç”¨ Realtimeï¼ˆ**éœ€è¦æ‰‹åŠ¨æ‰§è¡Œ**ï¼‰
  - [ ] Database â†’ Replication â†’ å‹¾é€‰ badcases

- [ ] åŠŸèƒ½æµ‹è¯•
  - [ ] åŒçª—å£æ–°å¢æµ‹è¯•é€šè¿‡
  - [ ] åŒçª—å£ç¼–è¾‘æµ‹è¯•é€šè¿‡
  - [ ] åŒçª—å£åˆ é™¤æµ‹è¯•é€šè¿‡
  - [ ] æ§åˆ¶å°æ˜¾ç¤ºè®¢é˜…æˆåŠŸ
  - [ ] å»¶è¿Ÿ < 3 ç§’

- [x] æ–‡æ¡£å®Œæ•´
  - [x] å¿«é€Ÿå‚è€ƒæ–‡æ¡£
  - [x] å®Œæ•´é…ç½®æŒ‡å—
  - [x] æµ‹è¯•æŒ‡å—
  - [x] æ›´æ–°æ—¥å¿—

- [x] æµ‹è¯•å·¥å…·
  - [x] å¯è§†åŒ–æµ‹è¯•é¡µé¢

---

## ğŸ“Š æŠ€æœ¯ç»†èŠ‚

### å·¥ä½œåŸç†

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   ç”¨æˆ· A    â”‚           â”‚  Supabase   â”‚           â”‚   ç”¨æˆ· B    â”‚
â”‚  (æµè§ˆå™¨)   â”‚           â”‚  (æ•°æ®åº“)   â”‚           â”‚  (æµè§ˆå™¨)   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚                         â”‚                         â”‚
       â”‚ 1. æ–°å¢ badcase         â”‚                         â”‚
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚                         â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚ 2. WebSocket é€šçŸ¥      â”‚
       â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€>â”‚
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚ 3. è·å–æ–°æ•°æ®          â”‚
       â”‚                         â”‚<â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
       â”‚                         â”‚                         â”‚
       â”‚                         â”‚ 4. æ›´æ–°ç•Œé¢            â”‚
       â”‚                         â”‚                         â–¼
       â”‚                         â”‚                   [æ˜¾ç¤ºæ–°è®°å½•]
```

### äº‹ä»¶å¤„ç†

| äº‹ä»¶ç±»å‹ | è§¦å‘æ¡ä»¶ | å¤„ç†é€»è¾‘ |
|---------|---------|---------|
| INSERT | æ–°å¢è®°å½• | æ·»åŠ åˆ°æœ¬åœ°çŠ¶æ€ï¼Œé¿å…é‡å¤ |
| UPDATE | æ›´æ–°è®°å½• | æ›´æ–°æœ¬åœ°çŠ¶æ€ä¸­çš„å¯¹åº”è®°å½• |
| DELETE | åˆ é™¤è®°å½• | ä»æœ¬åœ°çŠ¶æ€ç§»é™¤ |

### æ€§èƒ½ä¼˜åŒ–

1. **äº‹ä»¶é¢‘ç‡é™åˆ¶**ï¼š`eventsPerSecond: 10`
2. **é‡å¤æ£€æŸ¥**ï¼šé¿å…åŒä¸€æ•°æ®é‡å¤æ·»åŠ 
3. **è‡ªåŠ¨é‡è¿**ï¼šç½‘ç»œæ–­å¼€åè‡ªåŠ¨é‡è¿
4. **æ¸…ç†æœºåˆ¶**ï¼šç»„ä»¶å¸è½½æ—¶æ¸…ç†è®¢é˜…

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœ

### ç”¨æˆ·ä½“éªŒæ”¹è¿›

| æŒ‡æ ‡ | æ”¹è¿›å‰ | æ”¹è¿›å | æå‡ |
|------|--------|--------|------|
| æ•°æ®åŒæ­¥ | éœ€è¦æ‰‹åŠ¨åˆ·æ–° | è‡ªåŠ¨åŒæ­¥ | â­â­â­â­â­ |
| å»¶è¿Ÿ | æ‰‹åŠ¨åˆ·æ–° (ç§’çº§) | 1-2ç§’ | â­â­â­â­â­ |
| ç”¨æˆ·ä½“éªŒ | è¾ƒå·® | ä¼˜ç§€ | â­â­â­â­â­ |
| å¤šäººåä½œ | ä¸æ”¯æŒ | æ”¯æŒ | â­â­â­â­â­ |

### é€‚ç”¨åœºæ™¯

âœ… **å¤šäººåä½œå¡«æŠ¥**
- å›¢é˜Ÿæˆå‘˜åŒæ—¶å¡«å†™ badcase
- å®æ—¶çœ‹åˆ°å½¼æ­¤çš„å·¥ä½œè¿›åº¦
- é¿å…é‡å¤å¡«æŠ¥

âœ… **å¤§å±å±•ç¤º**
- ä¼šè®®å®¤å¤§å±å®æ—¶å±•ç¤ºæ‰€æœ‰ badcase
- æ— éœ€äººå·¥åˆ·æ–°

âœ… **ç§»åŠ¨åŠå…¬**
- æ‰‹æœºå’Œç”µè„‘æ•°æ®å®æ—¶åŒæ­¥
- éšæ—¶éšåœ°æŸ¥çœ‹æœ€æ–°æ•°æ®

---

## ğŸ¯ åç»­ä¼˜åŒ–å»ºè®®

### çŸ­æœŸï¼ˆå¯é€‰ï¼‰

- [ ] æ·»åŠ "æœ‰æ–°æ•°æ®"æç¤ºéŸ³
- [ ] é«˜äº®æ˜¾ç¤ºæ–°å¢/æ›´æ–°çš„è®°å½•
- [ ] æ·»åŠ ç¦»çº¿ç¼“å­˜åŠŸèƒ½

### é•¿æœŸï¼ˆå¯é€‰ï¼‰

- [ ] å®ç°å†²çªè§£å†³æœºåˆ¶
- [ ] æ·»åŠ ç”¨æˆ·åœ¨çº¿çŠ¶æ€æ˜¾ç¤º
- [ ] æ”¯æŒå®æ—¶åä½œç¼–è¾‘

---

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: è®¢é˜…å¤±è´¥

**ç—‡çŠ¶**ï¼šæ§åˆ¶å°æ˜¾ç¤º `âŒ Realtime è®¢é˜…å¤±è´¥`

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ Supabase Dashboard ä¸­æ˜¯å¦å¯ç”¨äº† Realtime
2. æ£€æŸ¥ç½‘ç»œè¿æ¥
3. æ£€æŸ¥ Supabase é¡¹ç›®çŠ¶æ€

### é—®é¢˜ 2: å»¶è¿Ÿè¾ƒå¤§

**ç—‡çŠ¶**ï¼šæ•°æ®åŒæ­¥å»¶è¿Ÿ > 5 ç§’

**è§£å†³æ–¹æ¡ˆ**ï¼š
1. æ£€æŸ¥ç½‘ç»œé€Ÿåº¦
2. æ£€æŸ¥ Supabase æœåŠ¡çŠ¶æ€
3. å¦‚æœåœ¨å…è´¹ç‰ˆï¼Œè€ƒè™‘å‡çº§

### é—®é¢˜ 3: é‡å¤æ•°æ®

**ç—‡çŠ¶**ï¼šåŒä¸€æ¡è®°å½•æ˜¾ç¤ºå¤šæ¬¡

**è§£å†³æ–¹æ¡ˆ**ï¼š
- ä»£ç ä¸­å·²æœ‰é‡å¤æ£€æŸ¥é€»è¾‘
- æ¸…é™¤æµè§ˆå™¨ç¼“å­˜
- åˆ·æ–°é¡µé¢

---

## ğŸ“š å‚è€ƒèµ„æ–™

- [Supabase Realtime å®˜æ–¹æ–‡æ¡£](https://supabase.com/docs/guides/realtime)
- [PostgreSQL Change Data Capture](https://supabase.com/docs/guides/realtime/postgres-changes)
- [WebSocket è¿æ¥ç®¡ç†](https://supabase.com/docs/guides/realtime/troubleshooting)

---

## ğŸ“ è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜ï¼Œè¯·ï¼š
1. æŸ¥çœ‹ `REALTIME_SETUP.md` è¯¦ç»†æ–‡æ¡£
2. è¿è¡Œ `test-realtime.html` è¯Šæ–­å·¥å…·
3. æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°æ—¥å¿—

---

**å®ç°æ—¥æœŸ**: 2025-12-22  
**çŠ¶æ€**: âœ… ä»£ç å·²å®Œæˆï¼Œç­‰å¾… Supabase é…ç½®  
**ä¸‹ä¸€æ­¥**: åœ¨ Supabase Dashboard å¯ç”¨ Realtime å¹¶æµ‹è¯•

